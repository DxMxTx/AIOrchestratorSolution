@page "/"
@inject Kernel Kernel // Inyecta el objeto Kernel de Semantic Kernel

<h1>¡Bienvenido a tu Orquestador de IA!</h1>
<p>Vamos a probar Semantic Kernel para generar texto.</p>

<SfTextBox Placeholder="Escribe tu prompt aquí..."
           @bind-Value="@userPrompt"
           FloatLabelType="FloatLabelType.Auto"
           Multiline="true"
           CssClass="e-filled"
           Width="100%"></SfTextBox>

<SfButton Content="Generar Respuesta (con IA)"
          OnClick="GenerateResponse"
          CssClass="e-primary"
          IsPrimary="true"
          Style="margin-top: 15px;"></SfButton>

@if (!string.IsNullOrEmpty(aiResponse))
{
    <h3>Respuesta de la IA:</h3>
    <div class="card" style="padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9;">
        <p>@((MarkupString)aiResponse)</p>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert" style="margin-top: 15px;">
        Error: @errorMessage
    </div>
}

@code {
    private string userPrompt = "";
    private string aiResponse = "";
    private string errorMessage = "";
    private IChatCompletionService _chatCompletionService;

    protected override void OnInitialized()
    {
        // Este método se llama cuando el componente se inicializa
        // Obtener el servicio de chat del Kernel inyectado
        _chatCompletionService = Kernel.GetRequiredService<IChatCompletionService>();
    }

    private async Task GenerateResponse()
    {
        aiResponse = ""; // Limpia la respuesta anterior
        errorMessage = ""; // Limpia cualquier error anterior

        if (string.IsNullOrWhiteSpace(userPrompt))
        {
            errorMessage = "Por favor, introduce un prompt.";
            return;
        }

        try
        {
            // Crear un historial de chat para darle contexto a la IA
            var chatHistory = new ChatHistory();
            chatHistory.AddSystemMessage("Eres un asistente útil que responde de manera concisa y clara. Siempre debes ser respetuoso."); // Instrucción inicial a la IA
            chatHistory.AddUserMessage(userPrompt); // El prompt que el usuario ha escrito

            // Realizar la llamada a la IA a través de Semantic Kernel
            var result = await _chatCompletionService.GetChatMessageContentAsync(chatHistory);
            aiResponse = result.Content; // Obtener la respuesta de la IA
        }
        catch (Exception ex)
        {
            errorMessage = $"Ocurrió un error al contactar a la IA: {ex.Message}";
            // En una aplicación real, aquí también podrías loguear el error en un sistema de logs
        }
    }
}